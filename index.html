<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Course App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        window.DEFAULT_CONFIG = [
            { id: 1, title: "–ú–æ–¥—É–ª—å 1: –í–≤–µ–¥–µ–Ω–∏–µ", deadline: new Date(Date.now() + 86400000).toISOString().slice(0,16) },
            { id: 2, title: "–ú–æ–¥—É–ª—å 2: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", deadline: new Date(Date.now() + 172800000).toISOString().slice(0,16) },
            { id: 3, title: "–ú–æ–¥—É–ª—å 3: –í–∏–∑—É–∞–ª", deadline: new Date(Date.now() + 259200000).toISOString().slice(0,16) },
            { id: 4, title: "–ú–æ–¥—É–ª—å 4: –¶–≤–µ—Ç –∏ —Å–µ—Ç–∫–∞", deadline: new Date(Date.now() + 345600000).toISOString().slice(0,16) },
            { id: 5, title: "–ú–æ–¥—É–ª—å 5: –®—Ä–∏—Ñ—Ç—ã", deadline: new Date(Date.now() + 432000000).toISOString().slice(0,16) },
            { id: 6, title: "–ú–æ–¥—É–ª—å 6: –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã", deadline: new Date(Date.now() + 518400000).toISOString().slice(0,16) },
            { id: 7, title: "–ú–æ–¥—É–ª—å 7: –¢–µ—Å—Ç—ã", deadline: new Date(Date.now() + 604800000).toISOString().slice(0,16) },
            { id: 8, title: "–ú–æ–¥—É–ª—å 8: –ê–Ω–∏–º–∞—Ü–∏—è", deadline: new Date(Date.now() + 691200000).toISOString().slice(0,16) },
            { id: 9, title: "–ú–æ–¥—É–ª—å 9: –í–µ—Ä—Å—Ç–∫–∞", deadline: new Date(Date.now() + 777600000).toISOString().slice(0,16) },
            { id: 10, title: "–ú–æ–¥—É–ª—å 10: –§–∏–Ω–∞–ª", deadline: new Date(Date.now() + 864000000).toISOString().slice(0,16) }
        ];

        let firebaseConfig = null;
        try { firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); } catch(e) {}
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.courseData = { 
            title: localStorage.getItem('courseTitle') || "–¢–≤–æ–π –ü—É—Ç—å", 
            tasks: JSON.parse(localStorage.getItem('courseConfig')) || window.DEFAULT_CONFIG 
        };
        window.userLevel = parseInt(localStorage.getItem('userCurrentLevel')) || 1;

        const init = async () => {
            if (typeof renderDashboard === 'function') {
                renderDashboard();
            }

            if (!firebaseConfig || !firebaseConfig.apiKey) return;

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const courseRef = doc(db, 'artifacts', appId, 'public', 'data', 'course_settings', 'data_doc');
                        
                        onSnapshot(courseRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                window.courseData = data;
                                localStorage.setItem('courseConfig', JSON.stringify(data.tasks));
                                localStorage.setItem('courseTitle', data.title);
                                renderDashboard();
                            }
                        }, (err) => console.log("Live update error:", err));

                        window.saveToCloudAction = async (tasks, title) => {
                            if (!auth.currentUser) return false;
                            try {
                                await setDoc(courseRef, { 
                                    tasks, 
                                    title, 
                                    updatedAt: new Date().toISOString() 
                                });
                                return true;
                            } catch (e) {
                                console.error("Cloud save failed:", e);
                                return false;
                            }
                        };
                    }
                });

            } catch (e) {
                console.error("Firebase init failed");
            }
        };

        window.onload = init;
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #0f172a, #000000);
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        
        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .task-active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
        }
        
        .task-locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .task-done { border-color: #10b981; background: rgba(16, 185, 129, 0.08); }
        
        .neon-text { text-shadow: 0 0 10px rgba(255, 255, 255, 0.2); }
        .neon-blue { text-shadow: 0 0 15px #3b82f6; }
        .neon-red { text-shadow: 0 0 15px #ef4444; color: #ef4444 !important; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: slideUp 0.4s ease-out forwards; }
        
        .pulse-ring {
            width: 10px; height: 10px; background: #3b82f6; border-radius: 50%;
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        #admin-panel.hidden, #custom-modal.hidden, #screen-detail.hidden { display: none; }

        input:invalid {
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body class="p-4 sm:p-6 flex justify-center">

    <div class="w-full max-w-md mx-auto flex flex-col h-full relative">
        <!-- DASHBOARD -->
        <div id="screen-dashboard" class="w-full pb-10">
            <header class="mb-6 flex justify-between items-end sticky top-0 z-10 py-4 bg-black/40 backdrop-blur-md -mx-4 px-4 rounded-b-2xl">
                <div onclick="adminClick()">
                    <h1 id="main-title" class="text-2xl font-extrabold tracking-tight neon-text select-none">–¢–≤–æ–π –ü—É—Ç—å</h1>
                    <p class="text-gray-400 text-xs mt-0.5">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <span id="progress-counter" class="text-white font-bold">0/0</span></p>
                </div>
                <button id="admin-btn" onclick="toggleAdmin()" class="hidden w-9 h-9 rounded-full bg-yellow-500/20 border border-yellow-500/40 flex items-center justify-center animate-bounce">
                    <i data-lucide="settings" class="text-yellow-500 w-4 h-4"></i>
                </button>
                <div id="default-icon" class="w-10 h-10 rounded-full bg-blue-900/20 flex items-center justify-center border border-blue-500/20">
                    <i data-lucide="layout" class="text-blue-400 w-5 h-5"></i>
                </div>
            </header>
            <div id="tasks-list" class="space-y-3"></div>
        </div>

        <!-- COMPACT DETAIL MODAL -->
        <div id="screen-detail" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-6 flex items-center justify-center animate-in">
            <div class="glass-panel p-6 w-full max-w-[340px] relative shadow-2xl">
                <button onclick="goBack()" class="absolute -top-12 left-0 text-gray-400 flex items-center gap-2 text-sm">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
                </button>
                
                <h2 id="detail-title" class="text-lg font-bold mb-1 text-center text-blue-400 uppercase tracking-wider"></h2>
                <div class="flex flex-col items-center mb-6">
                    <span class="text-[9px] uppercase tracking-[0.2em] text-gray-500 mb-1 text-center">–î–µ–¥–ª–∞–π–Ω –º–æ–¥—É–ª—è</span>
                    <div id="detail-timer" class="text-3xl font-black tabular-nums neon-blue">00:00:00</div>
                </div>

                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-400 uppercase ml-1">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É</label>
                        <input type="url" id="work-url" placeholder="https://..." required
                               class="w-full px-4 py-3 rounded-xl text-white bg-black/40 border border-gray-800 focus:border-blue-500 outline-none text-sm transition-all">
                    </div>
                    <div id="buttons-container" class="space-y-2">
                        <button id="submit-btn" onclick="submitTask()" class="w-full py-3.5 rounded-xl font-bold uppercase tracking-wider text-[11px] bg-blue-600 shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É
                        </button>
                        <button id="late-submit-btn" onclick="submitTask(true)" class="hidden w-full py-3.5 rounded-xl font-bold uppercase tracking-wider text-[11px] bg-red-600/20 text-red-500 border border-red-500/40 active:scale-95 transition-all">
                            –°–¥–∞—Ç—å —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="hidden fixed inset-0 z-[60] bg-slate-950 p-6 overflow-y-auto">
        <div class="w-full max-w-md mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-yellow-500 uppercase" id="admin-panel-title">–†–µ–¥–∞–∫—Ç–æ—Ä</h2>
                <button onclick="toggleAdmin()" class="px-3 py-1 bg-white/10 rounded-lg text-xs">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            
            <!-- ADMIN ONLY SECTION -->
            <div id="admin-full-controls" class="hidden">
                <div class="mb-4 p-4 bg-white/5 rounded-xl border border-white/10">
                    <label class="text-[10px] text-yellow-500 font-bold uppercase block mb-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫—É—Ä—Å–∞</label>
                    <input type="text" id="admin-course-title-input" class="w-full bg-transparent border-b border-white/20 py-1 text-base font-bold text-white outline-none">
                </div>
                <div id="admin-inputs" class="space-y-3 pb-4"></div>
                <button onclick="addModule()" class="w-full py-3 mb-6 bg-white/5 rounded-xl text-xs font-bold uppercase tracking-widest">+ –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å</button>
            </div>

            <!-- COMMON RESET SECTION -->
            <div class="mb-6 p-4 bg-red-500/10 rounded-xl border border-red-500/20">
                <label class="text-[10px] text-red-500 font-bold uppercase block mb-2">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</label>
                <button onclick="resetStudentProgress()" class="w-full py-3 bg-red-600/20 text-red-500 border border-red-500/40 rounded-lg text-[10px] font-bold uppercase tracking-widest hover:bg-red-600 hover:text-white transition-all">
                    –°–±—Ä–æ—Å–∏—Ç—å –ª–∏—á–Ω–æ –º–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
                </button>
            </div>

            <!-- ADMIN SAVE BUTTON -->
            <div id="admin-save-btn-container" class="hidden fixed bottom-0 left-0 w-full p-4 bg-slate-950 border-t border-white/10">
                 <button onclick="saveAdminData()" class="w-full py-4 bg-yellow-600 rounded-xl font-bold text-black uppercase text-xs tracking-widest">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION MODAL -->
    <div id="custom-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 hidden p-6 backdrop-blur-md">
        <div class="glass-panel p-6 w-full max-w-xs text-center">
            <h3 id="modal-title" class="text-lg font-bold mb-1"></h3>
            <p id="modal-message" class="text-gray-400 mb-6 text-xs"></p>
            <div id="modal-buttons" class="flex gap-2"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const REAL_ADMIN_ID = "553316521"; // –¢–≤–æ–π ID
        tg.expand();
        tg.ready();

        let clickCount = 0;
        function adminClick() {
            clickCount++;
            if (clickCount >= 5) {
                document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('default-icon').classList.add('hidden');
            }
            setTimeout(() => clickCount = 0, 2000);
        }

        function toggleAdmin() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                const currentUserId = tg.initDataUnsafe?.user?.id?.toString() || "unknown";
                const isAdmin = currentUserId === REAL_ADMIN_ID;
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤
                const fullControls = document.getElementById('admin-full-controls');
                const saveBtnContainer = document.getElementById('admin-save-btn-container');
                const panelTitle = document.getElementById('admin-panel-title');

                if (isAdmin) {
                    fullControls.classList.remove('hidden');
                    saveBtnContainer.classList.remove('hidden');
                    panelTitle.innerText = "–†–µ–¥–∞–∫—Ç–æ—Ä –∫—É—Ä—Å–∞";
                    document.getElementById('admin-course-title-input').value = window.courseData.title || "";
                    renderAdminInputs();
                } else {
                    fullControls.classList.add('hidden');
                    saveBtnContainer.classList.add('hidden');
                    panelTitle.innerText = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—á–µ–Ω–∏–∫–∞";
                }
            }
        }

        function renderAdminInputs() {
            const container = document.getElementById('admin-inputs');
            const tasks = window.courseData.tasks || [];
            container.innerHTML = tasks.map((t, i) => `
                <div class="p-3 bg-white/5 rounded-xl border border-white/10 relative">
                    <button onclick="removeModule(${i})" class="absolute top-2 right-2 text-gray-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                    <input type="text" id="adm-t-${i}" value="${t.title}" class="w-full bg-transparent border-b border-white/10 py-1 text-xs mb-2 outline-none">
                    <input type="datetime-local" id="adm-d-${i}" value="${t.deadline}" class="w-full bg-white/10 rounded p-1 text-white text-[10px] outline-none">
                </div>
            `).join('');
            if (window.lucide) lucide.createIcons();
        }

        function addModule() {
            if (!window.courseData.tasks) window.courseData.tasks = [];
            window.courseData.tasks.push({ id: Date.now(), title: "–ù–æ–≤—ã–π –º–æ–¥—É–ª—å", deadline: new Date().toISOString().slice(0,16) });
            renderAdminInputs();
        }

        function removeModule(index) {
            window.courseData.tasks.splice(index, 1);
            renderAdminInputs();
        }

        function resetStudentProgress() {
            showModal("–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞", "–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∫ —É—á–µ–Ω–∏–∫–∞ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω –¥–æ –ø–µ—Ä–≤–æ–≥–æ –º–æ–¥—É–ª—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?", (ok) => {
                if(ok) {
                    window.userLevel = 1;
                    localStorage.setItem('userCurrentLevel', 1);
                    renderDashboard();
                    toggleAdmin();
                    showModal("–°–±—Ä–æ—à–µ–Ω–æ", "–¢–≤–æ–π –ª–∏—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω.", null, false);
                }
            });
        }

        async function saveAdminData() {
            const title = document.getElementById('admin-course-title-input').value;
            const tasks = window.courseData.tasks.map((t, i) => {
                const titleVal = document.getElementById(`adm-t-${i}`).value;
                const dateVal = document.getElementById(`adm-d-${i}`).value;
                return {
                    id: t.id || Date.now() + i,
                    title: titleVal,
                    deadline: dateVal
                };
            });
            
            if(window.saveToCloudAction) {
                const success = await window.saveToCloudAction(tasks, title);
                if (success) {
                    showModal("–£—Å–ø–µ—à–Ω–æ", "–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ –¥–ª—è –≤—Å–µ—Ö.", null, false);
                    toggleAdmin();
                } else {
                    showModal("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ.");
                }
            } else {
                window.courseData = { tasks, title };
                localStorage.setItem('courseConfig', JSON.stringify(tasks));
                localStorage.setItem('courseTitle', title);
                renderDashboard();
                toggleAdmin();
                showModal("–õ–æ–∫–∞–ª—å–Ω–æ", "–û–±–ª–∞–∫–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ —É —Ç–µ–±—è.", null, false);
            }
        }

        function renderDashboard() {
            if (!window.courseData || !window.courseData.tasks) return;
            document.getElementById('main-title').innerText = window.courseData.title || "–¢–≤–æ–π –ü—É—Ç—å";
            const tasks = window.courseData.tasks;
            const container = document.getElementById('tasks-list');
            container.innerHTML = '';
            document.getElementById('progress-counter').innerText = `${Math.min(window.userLevel-1, tasks.length)}/${tasks.length}`;

            tasks.forEach((task, index) => {
                const level = index + 1;
                let statusClass='', icon='', isClickable=false;

                if (level < window.userLevel) {
                    statusClass = 'task-done';
                    icon = '<i data-lucide="check-circle-2" class="text-emerald-400 w-6 h-6"></i>';
                } else if (level === window.userLevel) {
                    statusClass = 'task-active cursor-pointer';
                    icon = '<div class="pulse-ring"></div>';
                    isClickable = true;
                } else {
                    statusClass = 'task-locked';
                    icon = '<i data-lucide="lock" class="text-gray-600 w-5 h-5"></i>';
                }

                const d = new Date(task.deadline || Date.now());
                const dateStr = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                const timeStr = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                container.insertAdjacentHTML('beforeend', `
                    <div class="glass-panel p-5 task-card ${statusClass} animate-in" 
                         onclick="${isClickable ? `openTask(${task.id})` : ''}">
                        <div class="flex flex-col flex-1 pr-4">
                            <span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mb-1">–≠—Ç–∞–ø ${level}</span>
                            <h3 class="text-base font-bold mb-1 leading-tight">${task.title}</h3>
                            <div class="text-[10px] text-gray-400">
                                <i data-lucide="calendar" class="w-3 h-3 inline mr-0.5"></i> –î–æ ${dateStr} –≤ ${timeStr}
                            </div>
                        </div>
                        <div class="flex-shrink-0 flex items-center justify-center w-10">
                            ${icon}
                        </div>
                    </div>
                `);
            });
            if (window.lucide) lucide.createIcons();
        }

        let activeTaskId = null, timerInterval = null;
        function openTask(id) {
            activeTaskId = id;
            const task = window.courseData.tasks.find(t => t.id === id);
            if(!task) return;
            document.getElementById('detail-title').innerText = task.title;
            document.getElementById('screen-detail').classList.remove('hidden');
            document.getElementById('work-url').value = '';
            
            const btn = document.getElementById('submit-btn');
            const lateBtn = document.getElementById('late-submit-btn');
            const el = document.getElementById('detail-timer');
            
            if(timerInterval) clearInterval(timerInterval);
            const updateTimer = () => {
                const diff = new Date(task.deadline) - new Date();
                
                if (diff <= 0) { 
                    el.innerText = "00:00:00"; 
                    el.classList.add('neon-red');
                    el.classList.remove('neon-blue');
                    btn.disabled = true;
                    btn.innerText = "–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ";
                    btn.classList.replace('bg-blue-600', 'bg-gray-700');
                    btn.style.opacity = "0.5";
                    lateBtn.classList.remove('hidden');
                    return; 
                }
                
                el.classList.remove('neon-red');
                el.classList.add('neon-blue');
                btn.disabled = false;
                btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É";
                btn.classList.add('bg-blue-600');
                btn.classList.remove('bg-gray-700');
                btn.style.opacity = "1";
                lateBtn.classList.add('hidden');

                const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
                el.innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            };
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function goBack() {
            document.getElementById('screen-detail').classList.add('hidden');
            if(timerInterval) clearInterval(timerInterval);
        }

        async function sendToBot(workUrl, taskTitle, isLate = false) {
            const BOT_TOKEN = "8540525298:AAFa-g6oM6LgTmCJ9NwP6rFHW1DIyhu67y0";
            const ADMIN_ID = 553316521;
            
            const user = tg.initDataUnsafe?.user || {};
            const name = user.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const username = user.username ? `@${user.username}` : '–Ω–µ —É–∫–∞–∑–∞–Ω';
            const userId = user.id || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            
            const statusLabel = isLate ? "‚ùå –ü–û–°–õ–ï –î–ï–î–õ–ê–ô–ù–ê" : "‚úÖ –í–û–í–†–ï–ú–Ø";
            const progress = `${window.userLevel}/${window.courseData.tasks.length}`;

            const text = `üì¨ <b>–ù–û–í–ê–Ø –†–ê–ë–û–¢–ê</b>\n\n` +
                         `üë§ <b>–ò–º—è:</b> ${name}\n` +
                         `üîó <b>–õ–æ–≥–∏–Ω:</b> ${username}\n` +
                         `üÜî <b>ID:</b> ${userId}\n\n` +
                         `üìÇ <b>–°—Å—ã–ª–∫–∞:</b> ${workUrl}\n` +
                         `‚è≥ <b>–°—Ç–∞—Ç—É—Å:</b> ${statusLabel}\n\n` +
                         `üìö <b>–ú–æ–¥—É–ª—å:</b> ${taskTitle}\n` +
                         `üìà <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> ${progress}`;

            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: ADMIN_ID,
                        text: text,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                });
                return response.ok;
            } catch (e) {
                console.error("Bot send error:", e);
                return false;
            }
        }

        async function submitTask(isLate = false) {
            const btn = isLate ? document.getElementById('late-submit-btn') : document.getElementById('submit-btn');
            const urlInput = document.getElementById('work-url');
            const workUrl = urlInput.value;
            
            if (!workUrl) {
                return showModal("–û—à–∏–±–∫–∞", "–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É.");
            }
            
            if (!urlInput.validity.valid || !workUrl.startsWith('http')) {
                return showModal("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å —Å—Å—ã–ª–∫–∏ (http:// –∏–ª–∏ https://).");
            }

            const confirmMsg = isLate ? "–°–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º? –≠—Ç–æ –±—É–¥–µ—Ç –æ—Ç–º–µ—á–µ–Ω–æ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞." : "–í–∞—à–∞ —Ä–∞–±–æ—Ç–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.";

            showModal("–°–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É?", confirmMsg, async (ok) => {
                if (ok) {
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                    const originalText = btn.innerText;
                    btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

                    const currentTaskIndex = window.userLevel - 1;
                    const currentTask = window.courseData.tasks[currentTaskIndex];
                    const taskTitle = currentTask?.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";

                    const sent = await sendToBot(workUrl, taskTitle, isLate);
                    
                    if (sent) {
                        if (activeTaskId === currentTask?.id) {
                            window.userLevel++;
                            localStorage.setItem('userCurrentLevel', window.userLevel);
                        }
                        goBack();
                        renderDashboard();
                        const successMsg = isLate ? "–†–∞–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω." : "–í–∞—à–∞ —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞! –í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É.";
                        showModal("–£—Å–ø–µ—à–Ω–æ", successMsg, null, false);
                    } else {
                        showModal("–û—à–∏–±–∫–∞", "–ë–æ—Ç –Ω–µ –ø—Ä–∏–Ω—è–ª —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å —Å–≤—è–∑—å.");
                    }
                    
                    btn.disabled = false;
                    btn.innerText = originalText;
                    btn.style.opacity = "1";
                }
            });
        }

        function showModal(t, m, cb = null, showCancel = true) {
            const el = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = t;
            document.getElementById('modal-message').innerText = m;
            const b = document.getElementById('modal-buttons'); b.innerHTML = '';
            const btn = (txt, cls, fn) => {
                const bt = document.createElement('button');
                bt.className = `flex-1 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition-all ${cls}`;
                bt.innerText = txt; bt.onclick = fn; b.appendChild(bt);
            }
            if(showCancel && cb) btn("–û—Ç–º–µ–Ω–∞", "bg-white/5", () => { el.classList.add('hidden'); });
            btn("–û–ö", "bg-blue-600", () => { el.classList.add('hidden'); if(cb) cb(true); });
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>
